import*as e from"react";import t,{createContext as r,Component as n,useState as o,useEffect as i,useContext as s}from"react";import{initialize as a}from"launchdarkly-js-client-sdk";export*from"launchdarkly-js-client-sdk";import l from"lodash.camelcase";import c from"hoist-non-react-statics";const p={useCamelCaseFlagKeys:!0,sendEventsOnFlagRead:!0},u=r({flags:{},flagKeyMap:{},ldClient:void 0}),{Provider:f,Consumer:d}=u,y=e=>{var t;return null!=(t=e.context)?t:e.user},h=e=>{const t={};for(const r in e)0!==r.indexOf("$")&&(t[l(r)]=e[r]);return t},g=(e,t)=>{const r={};for(const n in e)t&&void 0===t[n]||(r[n]=e[n].current);return r},O=(e,t)=>{const r=e.allFlags();return t?Object.keys(t).reduce(((e,n)=>(e[n]=Object.prototype.hasOwnProperty.call(r,n)?r[n]:t[n],e)),{}):r};function b(e,t,r=p,n){const o=function(e,t){if(void 0===t)return e;return Object.keys(t).reduce(((t,r)=>(m(e,r)&&(t[r]=e[r]),t)),{})}(t,n),{useCamelCaseFlagKeys:i=!0}=r,[s,a={}]=i?function(e){const t={},r={};for(const n in e){if(0===n.indexOf("$"))continue;const o=l(n);t[o]=e[n],r[o]=n}return[t,r]}(o):[o];return{flags:r.sendEventsOnFlagRead?v(e,s,a,i):s,flagKeyMap:a}}function m(e,t){return Object.prototype.hasOwnProperty.call(e,t)}function v(e,t,r,n){return new Proxy(t,{get(t,o,i){const s=Reflect.get(t,o,i),a=n&&m(r,o)||m(t,o);if("symbol"==typeof o||!a)return s;if(void 0===s)return;const l=n?r[o]:o;return e.variation(l,s)}})}h.camelCaseKeys=h;const j={wrapperName:"react-client-sdk",wrapperVersion:"3.4.0",sendEventsOnlyForVariation:!0};var w=Object.defineProperty,C=Object.defineProperties,P=Object.getOwnPropertyDescriptors,x=Object.getOwnPropertySymbols,F=Object.prototype.hasOwnProperty,E=Object.prototype.propertyIsEnumerable,S=(e,t,r)=>t in e?w(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,k=(e,t)=>{for(var r in t||(t={}))F.call(t,r)&&S(e,r,t[r]);if(x)for(var r of x(t))E.call(t,r)&&S(e,r,t[r]);return e},D=(e,t)=>C(e,P(t)),I=(e,t,r)=>new Promise(((n,o)=>{var i=e=>{try{a(r.next(e))}catch(e){o(e)}},s=e=>{try{a(r.throw(e))}catch(e){o(e)}},a=e=>e.done?n(e.value):Promise.resolve(e.value).then(i,s);a((r=r.apply(e,t)).next())}));class K extends n{constructor(e){super(e),this.getReactOptions=()=>k(k({},p),this.props.reactOptions),this.subscribeToChanges=e=>{const{flags:t}=this.props;e.on("change",(r=>{const n=this.getReactOptions(),o=g(r,t),i=k(k({},this.state.unproxiedFlags),o);Object.keys(o).length>0&&this.setState((r=>k(D(k({},r),{unproxiedFlags:i}),b(e,i,n,t))))}))},this.onFailed=(e,t)=>{this.setState((e=>D(k({},e),{error:t})))},this.onReady=(e,t,r)=>{const n=O(e,r);this.setState((o=>k(D(k({},o),{unproxiedFlags:n}),b(e,n,t,r))))},this.prepareLDClient=()=>I(this,null,(function*(){var e;const{clientSideID:t,flags:r,options:n}=this.props;let o=yield this.props.ldClient;const i=this.getReactOptions();let s,l=this.state.unproxiedFlags;if(o)l=O(o,r);else{const c=null!=(e=y(this.props))?e:{anonymous:!0,kind:"user"};o=a(t,c,k(k({},j),n));try{yield o.waitForInitialization(this.props.timeout),l=O(o,r)}catch(e){s=e,(null==s?void 0:s.name.toLowerCase().includes("timeout"))&&(o.on("failed",this.onFailed),o.on("ready",(()=>{this.onReady(o,i,r)})))}}this.setState((e=>D(k(D(k({},e),{unproxiedFlags:l}),b(o,l,i,r)),{ldClient:o,error:s}))),this.subscribeToChanges(o)}));const{options:t}=e;if(this.state={flags:{},unproxiedFlags:{},flagKeyMap:{}},t){const{bootstrap:e}=t;if(e&&"localStorage"!==e){const{useCamelCaseFlagKeys:t}=this.getReactOptions();this.state={flags:t?h(e):e,unproxiedFlags:e,flagKeyMap:{}}}}}componentDidMount(){return I(this,null,(function*(){const{deferInitialization:e}=this.props;e&&!y(this.props)||(yield this.prepareLDClient())}))}componentDidUpdate(e){return I(this,null,(function*(){const{deferInitialization:t}=this.props,r=!y(e)&&y(this.props);t&&r&&(yield this.prepareLDClient())}))}render(){const{flags:e,flagKeyMap:r,ldClient:n,error:o}=this.state;return t.createElement(f,{value:{flags:e,flagKeyMap:r,ldClient:n,error:o}},this.props.children)}}var R=Object.defineProperty,M=Object.defineProperties,L=Object.getOwnPropertyDescriptors,z=Object.getOwnPropertySymbols,T=Object.prototype.hasOwnProperty,V=Object.prototype.propertyIsEnumerable,$=(e,t,r)=>t in e?R(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,N=(e,t)=>{for(var r in t||(t={}))T.call(t,r)&&$(e,r,t[r]);if(z)for(var r of z(t))V.call(t,r)&&$(e,r,t[r]);return e};function U(t){return function(r){const{reactOptions:n}=t,o=N(N({},p),n),i=(s=N({},t),M(s,L({reactOptions:o})));var s;function a(t){return e.createElement(K,N({},i),e.createElement(r,N({},t)))}return c(a,r),a}}var q=Object.defineProperty,A=Object.defineProperties,B=Object.getOwnPropertyDescriptors,G=Object.getOwnPropertySymbols,H=Object.prototype.hasOwnProperty,J=Object.prototype.propertyIsEnumerable,Q=(e,t,r)=>t in e?q(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,W=(e,t)=>{for(var r in t||(t={}))H.call(t,r)&&Q(e,r,t[r]);if(G)for(var r of G(t))J.call(t,r)&&Q(e,r,t[r]);return e},X=(e,t)=>A(e,B(t));function Y(e){return r=this,n=null,s=function*(){var r,n;const{clientSideID:s,flags:l,options:c,reactOptions:u}=e,d=W(W({},p),u),h=null!=(r=y(e))?r:{anonymous:!0,kind:"user"};let m,v={};const w=null!=(n=yield e.ldClient)?n:a(s,h,W(W({},j),c));try{yield w.waitForInitialization(e.timeout),v=O(w,l)}catch(e){m=e}const C=(null==c?void 0:c.bootstrap)&&"localStorage"!==c.bootstrap?c.bootstrap:v;return({children:e})=>{const[r,n]=o((()=>X(W({unproxiedFlags:C},b(w,C,d,l)),{ldClient:w,error:m})));i((()=>{function e(e){const t=g(e,l);Object.keys(t).length>0&&n((e=>{const r=W(W({},e.unproxiedFlags),t);return W(X(W({},e),{unproxiedFlags:r}),b(w,r,d,l))}))}function t(){const e=O(w,l);n((t=>W(X(W({},t),{unproxiedFlags:e}),b(w,e,d,l))))}function r(e){n((t=>X(W({},t),{error:e})))}return w.on("change",e),(null==m?void 0:m.name.toLowerCase().includes("timeout"))&&(w.on("failed",r),w.on("ready",t)),function(){w.off("change",e),w.off("failed",r),w.off("ready",t)}}),[]);const s=((e,t)=>{var r={};for(var n in e)H.call(e,n)&&t.indexOf(n)<0&&(r[n]=e[n]);if(null!=e&&G)for(var n of G(e))t.indexOf(n)<0&&J.call(e,n)&&(r[n]=e[n]);return r})(r,["unproxiedFlags"]);return t.createElement(f,{value:s},e)}},new Promise(((e,t)=>{var o=e=>{try{a(s.next(e))}catch(e){t(e)}},i=e=>{try{a(s.throw(e))}catch(e){t(e)}},a=t=>t.done?e(t.value):Promise.resolve(t.value).then(o,i);a((s=s.apply(r,n)).next())}));var r,n,s}var Z=Object.defineProperty,_=Object.getOwnPropertySymbols,ee=Object.prototype.hasOwnProperty,te=Object.prototype.propertyIsEnumerable,re=(e,t,r)=>t in e?Z(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,ne=(e,t)=>{for(var r in t||(t={}))ee.call(t,r)&&re(e,r,t[r]);if(_)for(var r of _(t))te.call(t,r)&&re(e,r,t[r]);return e};function oe(t={clientOnly:!1}){return function(r){return n=>e.createElement(d,null,(({flags:o,ldClient:i})=>t.clientOnly?e.createElement(r,ne({ldClient:i},n)):e.createElement(r,ne({flags:o,ldClient:i},n))))}}const ie=()=>{const{flags:e}=s(u);return e},se=()=>{const{ldClient:e}=s(u);return e};function ae(){const{error:e}=s(u);return e}export{K as LDProvider,Y as asyncWithLDProvider,h as camelCaseKeys,p as defaultReactOptions,ie as useFlags,se as useLDClient,ae as useLDClientError,oe as withLDConsumer,U as withLDProvider};
//# sourceMappingURL=index.js.map
